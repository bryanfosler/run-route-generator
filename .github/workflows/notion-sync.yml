name: Sync Issues to Notion

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest
    steps:
      - name: Sync issue to Notion database
        uses: actions/github-script@v7
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;

            const notionKey = process.env.NOTION_API_KEY;
            const dbId = process.env.NOTION_DATABASE_ID;

            // Map GitHub issue state to Notion status
            const statusMap = {
              open: 'Open',
              closed: 'Done'
            };
            const status = statusMap[issue.state] || 'Open';
            const labels = issue.labels.map(l => l.name);

            // Search for existing page with this issue URL
            const searchRes = await fetch(`https://api.notion.com/v1/databases/${dbId}/query`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${notionKey}`,
                'Content-Type': 'application/json',
                'Notion-Version': '2022-06-28'
              },
              body: JSON.stringify({
                filter: {
                  property: 'GitHub URL',
                  url: { equals: issue.html_url }
                }
              })
            });
            const searchData = await searchRes.json();
            const existingPage = searchData.results && searchData.results[0];

            const properties = {
              'Title': {
                title: [{ text: { content: `#${issue.number} ${issue.title}` } }]
              },
              'Status': {
                select: { name: status }
              },
              'Labels': {
                multi_select: labels.map(l => ({ name: l }))
              },
              'GitHub URL': {
                url: issue.html_url
              },
              'Created': {
                date: { start: issue.created_at }
              }
            };

            if (existingPage) {
              // Update existing page
              const updateRes = await fetch(`https://api.notion.com/v1/pages/${existingPage.id}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${notionKey}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({ properties })
              });
              const updateData = await updateRes.json();
              if (updateData.id) {
                console.log(`Updated Notion page for issue #${issue.number}`);
              } else {
                console.log('Update response:', JSON.stringify(updateData));
              }
            } else {
              // Create new page
              const createRes = await fetch('https://api.notion.com/v1/pages', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${notionKey}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({
                  parent: { database_id: dbId },
                  properties
                })
              });
              const createData = await createRes.json();
              if (createData.id) {
                console.log(`Created Notion page for issue #${issue.number}`);
              } else {
                console.log('Create response:', JSON.stringify(createData));
              }
            }
