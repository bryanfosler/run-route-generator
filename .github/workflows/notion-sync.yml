name: Sync Issues to Notion

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created]

permissions:
  issues: read

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest
    # Only run for issue events OR comments that contain time logs
    if: >
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'Time:'))
    steps:
      - name: Sync issue to Notion database
        uses: actions/github-script@v7
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        with:
          script: |
            const issue = context.payload.issue;
            const notionKey = process.env.NOTION_API_KEY;
            const dbId = '30a95da6-c9dc-805a-8dcc-cf1dc2694ea2';

            // Map GitHub issue state to Notion status
            const statusMap = { open: 'Open', closed: 'Done' };
            const status = statusMap[issue.state] || 'Open';
            const labels = issue.labels.map(l => l.name);

            // Parse time from a string like "1h30m", "45m", "2h", "90m"
            function parseMinutes(str) {
              let total = 0;
              const hours = str.match(/(\d+)\s*h/i);
              const mins = str.match(/(\d+)\s*m/i);
              if (hours) total += parseInt(hours[1]) * 60;
              if (mins) total += parseInt(mins[1]);
              return total;
            }

            // Fetch all comments and sum up time entries (format: "Time: Xh Ym")
            const commentsRes = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              per_page: 100
            });
            let totalMinutes = 0;
            for (const comment of commentsRes.data) {
              const match = comment.body.match(/Time:\s*([\dhmHM\s]+)/);
              if (match) {
                totalMinutes += parseMinutes(match[1]);
              }
            }

            // Search for existing page with this issue URL
            const searchRes = await fetch(`https://api.notion.com/v1/databases/${dbId}/query`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${notionKey}`,
                'Content-Type': 'application/json',
                'Notion-Version': '2022-06-28'
              },
              body: JSON.stringify({
                filter: {
                  property: 'GitHub URL',
                  url: { equals: issue.html_url }
                }
              })
            });
            const searchData = await searchRes.json();
            const existingPage = searchData.results && searchData.results[0];

            const properties = {
              'Title': {
                title: [{ text: { content: `#${issue.number} ${issue.title}` } }]
              },
              'Status': {
                select: { name: status }
              },
              'Labels': {
                multi_select: labels.map(l => ({ name: l }))
              },
              'GitHub URL': {
                url: issue.html_url
              },
              'Created': {
                date: { start: issue.created_at }
              },
              'Project': {
                select: { name: 'Route Generator' }
              },
              'Time Spent (min)': {
                number: totalMinutes
              }
            };

            if (existingPage) {
              const updateRes = await fetch(`https://api.notion.com/v1/pages/${existingPage.id}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${notionKey}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({ properties })
              });
              const updateData = await updateRes.json();
              if (updateData.id) {
                console.log(`Updated Notion page for issue #${issue.number} (${totalMinutes} min)`);
              } else {
                console.log('Update response:', JSON.stringify(updateData));
              }
            } else {
              const createRes = await fetch('https://api.notion.com/v1/pages', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${notionKey}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({
                  parent: { database_id: dbId },
                  properties
                })
              });
              const createData = await createRes.json();
              if (createData.id) {
                console.log(`Created Notion page for issue #${issue.number} (${totalMinutes} min)`);
              } else {
                console.log('Create response:', JSON.stringify(createData));
              }
            }
